---
title: "Dextromethorphan qualification report" # Title of the document
subtitle: "" # Subtitle of the document. May be left empty
author: "esqLABS GmbH"
date: "`r Sys.Date()`" # How to include time of creation?
params:
  # If `TRUE`, results will be loaded
  loadPreSimulatedResults: TRUE
  # Sub-folder where simulated results is located, in case `loadPreSimulatedResults`
  # is `TRUE`. If `NULL`, default results folder as specified in `ProjectConfiguration`
  # is used.
  loadResultsFolder: "2023-07-21 12-59"
  # Sub-folder where the results will be stored. If NULL, a folder in the "Results"
  # folder with current data name will be created.
  saveResultsFolder: NULL
  # If TRUE, parameters defined in "InputCode/TestParameters.R" will be applied to all
  # simulations
  setTestParameters: FALSE
  # If set to TRUE, only static content of the report will be generated,
  # i.e., R code will not be executed
  createOnlyStaticContent: FALSE
output-file: "Dextramethorphan qualification report"
format:
  pdf: 
    # table of contents and lists
    # Caption locations
    # Other
    # Figures rendering
    # Document layout as used by Word reports
    toc: true # display table of content (TOC)
    toc-depth: 3 # display three levels in TOC
    toc-title: Table of Content # override default "Content" TOC title
    lof: false # Print list of figures?
    lot: false # Print list of tables?
    fig-cap-location: bottom # figure captions location
    tbl-cap-location: bottom # table captions location
    number-sections: true # add number to sections
    colorlinks: true # links format
    fig-pos: "H" # ensure plots don't move to bottom of doc
    fig-align: center # plots are centered by default
    geometry:
      - top=25.4mm
      - bottom=25.4mm
      - left=25.4mm
      - right=25.4mm
    papersize: A4
   # fontfamily: "Segoe UI" # Can we use "Segoe UI Light" here?
execute:
  echo: false # do not show code chunks
  output: true
  warning: false # do not print warning
  cache: false # do not use cache unless specified in chunks
link-citations: TRUE
reference-section-title: "References"
editor:
  markdown:
    wrap: 72
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, include = FALSE, eval = !params$createOnlyStaticContent}
wd <- file.path(getwd(), "..")
setwd(wd)
source("Report/utilities-report/initEsqlabsProject.R")
projectConfiguration <- initEsqlabsProject()
```

```{r runSimulations, eval=!params$createOnlyStaticContent}
setwd(wd)
scenarioNames <- NULL
scenarioNames <- c(
  "Antecip Bioventures EM, 60 mg dextromethorphan hydrobromide multiple dose (capsule_solution), n=10_v9.1",
"Armani 2017 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=20_v9.1",
"Capon 1996 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=6_v9.1",
"Capon 1996 PM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=6_v9.1",
"Duedahl 2005 EM, 0.5 mg_kg dextromethorphan base (infusion), n=24_v9.1",
"Dumond 2010 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=23_v9.1",
"Edwards 2017 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=48_v9.1",
"Ermer 2015 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=30_v9.1",
"Feld 2013 EM, 60 mg dextromethorphan hydrobromide (capsule_solution), n=17_v9.1",
"Gazzaz 2018 NM, 30 mg dextromethorphan hydrobromide (cocktail), n=30, AS=1.25_v9.1",
"Gorski 2004 EM, 30 mg dextromethorphan hydromide (capsule_solution), n=11_v9.1",
"Gorski 2004 PM, 30 mg dextromethorphan hydromide (capsule_solution), n=1_v9.1",
"Kakuda 2014 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=14_v9.1",
"Khalilieh 2018 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=20_v9.1",
"Nakashima 2007 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=24_v9.1",
"Nyunt 2008 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=12_v9.1",
"Qiu 2016 IM, 15 mg dextromethorphan hydrobromide (capsule_solution), n=6, AS=0.5_v9.1",
"Qiu 2016 NM, 15 mg dextromethorphan hydrobromide (capsule_solution), n=6, AS=1.25_v9.1",
"Qiu 2016 NM, 15 mg dextromethorphan hydrobromide (capsule_solution), n=6, AS=2_v9.1",
"Sager 2014 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=10_v9.1",
"Schadel 1995 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=5_v9.1",
"Schadel 1995 PM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=4_v9.1",
"Stage 2018 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=12_v9.1",
"Storelli 2018 IM, 5 mg dextromethorphan base (capsule_solution), n=16_v9.1",
"Storelli 2018 NM, 5 mg dextromethorphan base (capsule_solution), n=17, AS=2_v9.1",
"Tennezé 1999 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=36_v9.1",
"Yamazaki 2017 IM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=12, AS=0.5_v9.1",
"Yamazaki 2017 NM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=11, AS=2_v9.1",
"Zawertailo 2009 NM, 3 mg_kg dextromethorphan hydrobromide (capsule_solution), n=6, AS=2_v9.1",
"Antecip Bioventures EM, 60 mg dextromethorphan hydrobromide multiple dose (capsule_solution), n=10_v11.2",
"Armani 2017 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=20_v11.2",
"Capon 1996 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=6_v11.2",
"Capon 1996 PM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=6_v11.2",
"Duedahl 2005 EM, 0.5 mg_kg dextromethorphan base (infusion), n=24_v11.2",
"Dumond 2010 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=23_v11.2",
"Edwards 2017 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=48_v11.2",
"Ermer 2015 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=30_v11.2",
"Feld 2013 EM, 60 mg dextromethorphan hydrobromide (capsule_solution), n=17_v11.2",
"Gazzaz 2018 NM, 30 mg dextromethorphan hydrobromide (cocktail), n=30, AS=1.25_v11.2",
"Gorski 2004 EM, 30 mg dextromethorphan hydromide (capsule_solution), n=11_v11.2",
"Gorski 2004 PM, 30 mg dextromethorphan hydromide (capsule_solution), n=1_v11.2",
"Kakuda 2014 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=14_v11.2",
"Khalilieh 2018 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=20_v11.2",
"Nakashima 2007 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=24_v11.2",
"Nyunt 2008 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=12_v11.2",
"Qiu 2016 IM, 15 mg dextromethorphan hydrobromide (capsule_solution), n=6, AS=0.5_v11.2",
"Qiu 2016 NM, 15 mg dextromethorphan hydrobromide (capsule_solution), n=6, AS=1.25_v11.2",
"Qiu 2016 NM, 15 mg dextromethorphan hydrobromide (capsule_solution), n=6, AS=2_v11.2",
"Sager 2014 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=10_v11.2",
"Schadel 1995 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=5_v11.2",
"Schadel 1995 PM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=4_v11.2",
"Stage 2018 EM, 30 mg dextromethorphan hydrobromide (cocktail), n=12_v11.2",
"Storelli 2018 IM, 5 mg dextromethorphan base (capsule_solution), n=16_v11.2",
"Storelli 2018 NM, 5 mg dextromethorphan base (capsule_solution), n=17, AS=2_v11.2",
"Tennezé 1999 EM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=36_v11.2",
"Yamazaki 2017 IM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=12, AS=0.5_v11.2",
"Yamazaki 2017 NM, 30 mg dextromethorphan hydrobromide (capsule_solution), n=11, AS=2_v11.2",
"Zawertailo 2009 NM, 3 mg_kg dextromethorphan hydrobromide (capsule_solution), n=6, AS=2_v11.2"
)
scenarioResults <- simulateScenarios(
  projectConfiguration = projectConfiguration,
  loadPreSimulatedResults = params$loadPreSimulatedResults,
  setTestParameters = params$setTestParameters,
  scenarioNames = scenarioNames,
  loadResultsFolder = params$loadResultsFolder,
  saveResultsFolder = params$saveResultsFolder
)
```

```{r loadData, message=FALSE, include = FALSE, eval = !params$createOnlyStaticContent}
setwd(wd)
# Load from PKML
observedData <- esqlabsR::loadObservedDataFromPKML(projectConfiguration)

# # Or load from excel
# dataSheets <- c("Sheet 1")
# 
# observedData <- esqlabsR::loadObservedData(
#   projectConfiguration = projectConfiguration,
#   sheets = dataSheets
# )
```

```{r createPlots, eval = !params$createOnlyStaticContent}
setwd(wd)
plotGridNames <- NULL
allPlots <- createPlotsFromExcel(
  simulatedScenarios = scenarioResults$simulatedScenarios,
  observedData = observedData,
  projectConfiguration = projectConfiguration,
  plotGridNames = plotGridNames
)
```

```{r exportPlots, eval = !params$createOnlyStaticContent}
# Export plots to png
#Create export configuration that will be used for exporting plots.
exportConfiguration <- createEsqlabsExportConfiguration(projectConfiguration)
# Figures should be saved in the same folder as the location of the report
# plus subfolder "Figures"
exportConfiguration$path <- file.path(getwd(), "Figures")
# Export each created plot
for (plotName in names(allPlots)){
  plot <- allPlots[[plotName]]
  # Replace "\" and "/" by "_" so the file name does not result in folders
      plotName <- gsub(pattern = "\\", "_", plotName, fixed = TRUE)
      plotName <- gsub(pattern = "/", "_", plotName, fixed = TRUE)
      exportConfiguration$name <- plotName
      # Save plot
      exportConfiguration$savePlot(plot, autoscaleText = FALSE)
}
```

\newpage

::: callout-note
```{r resultsOrigin, echo=FALSE, results='asis'}
if (params$loadPreSimulatedResults) {
  cat(
    "This report has been created with simulation results loaded from results folder ",
    params$loadResultsFolder, ".\n"
  )
} else {
  cat("This report has been created by running the simulations.")
}

if (params$setTestParameters) {
  cat("WARNING: `setTestParameters` is set to `TRUE`!")
}
```
:::

\newpage

# Introduction

This document describes the qualification of a published dextromethorphan physiologically-based pharmacokinetics (PBPK) model for use with the Open Systems Pharmacology Software (OSPS) Version 11.2.

The PBPK model has been developed with OSPS version 9.1 and published by @rüdesheim2022. Model snapshots have been downloaded on 16.06.2023 from the Open Systems Pharmacology (OSP) [repository](https://github.com/Open-Systems-Pharmacology/Dextromethorphan-Model). As of 16.06.2023, no model version qualified for OSP version 11.2 is publicly available.

# Methods

## Software

For recreating the original results from the publication, OSPS [version 9.1](https://github.com/Open-Systems-Pharmacology/PK-Sim/releases/tag/v9.1) was used. The qualification is done with OSPS [version 11.2.142](https://github.com/Open-Systems-Pharmacology/PK-Sim/releases/tag/v11.2.142).

## Drug-gene-interaction

The model is intended to be used in drug-drug interactions (DDI) simulations with dextromethorphan as a CYP2D6 victim. Drug-gene interactions (DGI) to describe variabilities of CYP2D6 activity are modeled as variations of the catalytic rate constant $k_{cat}$.

## Qualification process

1.  Import project snapshot "dextromethorphan_aggregated_simulations.json" in PK-Sim v9.1. During the import processes, the following error is thrown:

    `Information: Loading Project from snapshot file 'xxx.json'`

    `Warning: Snapshot is outdated and cannot be loaded for the following reason:`

    `Individual 'Gorski 2004 (96) PM, n=1 not found in the project.`

    `Error: Cannot load Simulation 'Gorski 2004 PM, 30 mg dextromethorphan hydromide (capsule/solution), n=1'`

    `Information: Project loaded from snapshot`\
    \
    Investigation of the project snapshot showed that an Individual "Gorski 2004 PM, n=1" is present in the project and is not used in any simulation. It was concluded that the missing individual "Gorski 2004 (96) PM, n=1" referenced in the simulation should be "Gorski 2004 PM, n=1". The snapshot was modified to reference the present individual. After the modification, the snapshot was successfully loaded.

2.  The snapshot contains 29 simulations. All simulations were exported to `*.pkml` for simulation in R.

3.  Import project snapshot "dextromethorphan_aggregated_simulations.json" in PK-Sim v11.2. During import, the following warning for each loaded simulation is shown:\
    `Warning: Snapshot parameter 'Ontogeny factor GI' was not found in 'CYP3A4'.` All simulations were exported to `*.pkml` for simulation in R.

4.  All observed data from the project created with version 11.2 were exported \`\*.pkml\` for loading in R.

5.  Simulations created with versions 9.1 and 11.2 were simulated and the results visually compared.

## Model consolidation

During conversion of projects created with versions before 11, a separate expression profile is created for each individual. To ensure that all individuals are using the same expression, expression profiles of the same protein were compared. All expression profiles for the same protein were equal. Therefore, the same expression profile was set in every individual, and the remaining profiles were removed.

# Results

Comparison of time-concentration profiles generated with the different software versions are presented in the following:

!!! When doing it in the loop, no caption is created (Figure xxx: blablabl). Why?
```{r printFigures, results = 'asis', eval = !params$createOnlyStaticContent}
for (plotName in names(allPlots)){
  plotName <- gsub(pattern = "\\", "_", plotName, fixed = TRUE)
  plotName <- gsub(pattern = "/", "_", plotName, fixed = TRUE)
  filePath <- file.path(getwd(), "Figures", paste0(plotName, ".png"))
  cat("![", plotName, "](", filePath,")\n")
}
```
